<!DOCTYPE html>
<html>
  <head>
    <title>Face + Location Auth</title>
  </head>
  <body>
    <h2>ğŸ“¸ Face + ğŸ—º Location Authentication</h2>
    <video id="video" width="320" height="240" autoplay></video><br /><br />
    <button onclick="capture()">ğŸ“¸ Capture & Validate</button>

    <h3>ğŸ§¾ Result:</h3>
    <pre id="status">Waiting for capture...</pre>

    <script>
      const video = document.getElementById("video");
      const status = document.getElementById("status");

      // Start webcam
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch((err) => {
          status.innerText = "âŒ Cannot access webcam: " + err;
        });

      async function capture() {
        status.innerText = "â³ Capturing and getting location...";

        // Get location
        let coords;
        try {
          coords = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
              (pos) => resolve(pos.coords),
              (err) => reject("âŒ Location denied or failed")
            );
          });
        } catch (err) {
          status.innerText = err;
          return;
        }

        // Capture webcam image
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        const blob = await new Promise((resolve) =>
          canvas.toBlob(resolve, "image/jpeg")
        );

        const formData = new FormData();
        formData.append("file", blob, "photo.jpg");
        formData.append("latitude", coords.latitude);
        formData.append("longitude", coords.longitude);

        // Send to backend
        try {
          const res = await fetch("http://localhost:8000/validate/", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();

          if (res.ok) {
            status.innerText = `
âœ… Face Matched: ${result.face_matched}
ğŸ“ Matched With: ${result.matched_with || "None"}
ğŸ”¢ Similarity: ${result.similarity?.toFixed(2) || 0}%
ğŸ“ Within Geo-Fence: ${result.location_ok}
ğŸ“ Distance from center: ${result.distance_m} meters
ğŸš¦ Final Status: ${result.status || "Unknown"}
          `.trim();
          } else {
            status.innerText = `âŒ Error: ${
              result.reason || result.detail || "Unknown error"
            }`;
          }
        } catch (err) {
          status.innerText = `âŒ Failed to connect to server: ${err}`;
        }
      }
    </script>
  </body>
</html>
